<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Library â€” Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script src="../js/firebase-master-config.js"></script>
    <script src="../js/config.js" type="module"></script>

    <script type="module">
        import { loadCurriculum } from "../js/curriculum/loader.js";
        import { getInitializedClients } from "../js/api.js";
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { formatChapterName } from "../js/utils.js";
        import { initializeAuthListener } from "../js/auth-paywall.js";

        // --- HELPER: Transliterate to Table Name (Copied/Shared logic) ---
        function buildTableName(chapterTitle, subject, grade) {
            const skipList = ["as","of","the","a","an","in","on","for","to","ki","ke","ka"];
            let clean = chapterTitle.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
            let words = clean.split(/\s+/);
            words = words.filter(w => !skipList.includes(w));
            if (words.length === 0) words = ["chapter"];
            const first = words[0];
            const last = words.length > 1 ? words[words.length - 1] : first;
            const subjectSlug = subject.trim().split(" ")[0].toLowerCase();
            return `${subjectSlug}_${first}_${last}_${grade}_quiz`;
        }

        window.loadSelection = async (user) => {
            const params = new URLSearchParams(window.location.search);
            const grade = params.get("grade") || "9";
            const subject = params.get("subject") || "Science";

            document.getElementById("page-title").textContent = `${subject} Library`;
            document.getElementById("back-link").href = `consoles/student.html?grade=${grade}`;

            try {
                // 1. Load Curriculum
                const curriculum = await loadCurriculum(grade);
                let data = curriculum[subject];

                // Ensure data structure consistency for rendering
                // If it's an array (Science/Math usually), wrap it in "General" or similar if needed,
                // but usually renderCurriculum handles it.
                // If Social Science, it's typically an object { History: [...], Civics: [...] }

                if (!data) {
                    document.getElementById("content-area").innerHTML = `<div class="text-center text-slate-400">No content found for ${subject}.</div>`;
                    return;
                }

                // 2. Load Mistakes to Identify Weak Areas
                const mistakeSet = new Set();
                if (user) {
                    const { db } = await getInitializedClients();
                    const q = query(collection(db, "mistake_notebook"), where("user_id", "==", user.uid));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // Store both raw slug and formatted name for robust matching
                        const raw = (d.topic || d.chapter_slug || "").toLowerCase();
                        const fmt = formatChapterName(raw).toLowerCase();
                        mistakeSet.add(raw);
                        mistakeSet.add(fmt);
                    });
                }

                renderCurriculum(data, subject, grade, mistakeSet);
            } catch (e) {
                console.error(e);
                document.getElementById("content-area").innerHTML = `<div class="text-center text-red-400">Failed to load library.</div>`;
            }
        };

        function renderCurriculum(data, subject, grade, mistakeSet) {
            const container = document.getElementById("content-area");
            let html = "";

            // Special handling for Social Science Sub-Navigation
            if (subject === "Social Science" && !Array.isArray(data)) {
                // Generate Tabs
                const disciplines = Object.keys(data);
                const activeDiscipline = disciplines[0]; // Default to first

                html += `
                    <div class="mb-8 overflow-x-auto pb-2 scrollbar-hide">
                        <div class="flex space-x-2">
                            ${disciplines.map((d, idx) => `
                                <button onclick="switchTab('${d}')"
                                    class="tab-btn px-4 py-2 rounded-full text-sm font-bold transition whitespace-nowrap ${idx === 0 ? 'bg-amber-100 text-amber-700 ring-2 ring-amber-200' : 'bg-white text-slate-500 hover:bg-slate-50 border border-slate-200'}"
                                    id="tab-${d}">
                                    ${d}
                                </button>
                            `).join("")}
                        </div>
                    </div>
                `;

                // Generate Content Sections (Hidden by default except first)
                disciplines.forEach((d, idx) => {
                    const isHidden = idx !== 0 ? "hidden" : "";
                    html += `<div id="content-${d}" class="tab-content ${isHidden}">
                        ${renderSection(d, data[d], subject, grade, mistakeSet)}
                    </div>`;
                });

                // Helper script for tabs
                window.switchTab = (tabId) => {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`content-${tabId}`).classList.remove('hidden');

                    document.querySelectorAll('.tab-btn').forEach(el => {
                        el.classList.remove('bg-amber-100', 'text-amber-700', 'ring-2', 'ring-amber-200');
                        el.classList.add('bg-white', 'text-slate-500', 'border', 'border-slate-200');
                    });
                    const btn = document.getElementById(`tab-${tabId}`);
                    btn.classList.remove('bg-white', 'text-slate-500', 'border', 'border-slate-200');
                    btn.classList.add('bg-amber-100', 'text-amber-700', 'ring-2', 'ring-amber-200');
                };

            } else {
                // Standard Rendering (Math, Science)
                if (Array.isArray(data)) {
                    html += renderSection("General", data, subject, grade, mistakeSet);
                } else {
                    Object.keys(data).forEach(category => {
                        html += renderSection(category, data[category], subject, grade, mistakeSet);
                    });
                }
            }

            container.innerHTML = html;
        }

        function renderSection(category, chapters, subject, grade, mistakeSet) {
            if (!chapters || !chapters.length) return "";

            const grid = chapters.map(ch => {
                const title = ch.chapter_title || ch.title || ch;
                // Try to get explicit slug if available, else build table name
                const slug = ch.slug || buildTableName(title, subject, grade);
                const formattedName = formatChapterName(slug);

                // Check match against mistake set (both raw slug and formatted name)
                const isCritical = mistakeSet.has(slug.toLowerCase()) || mistakeSet.has(formattedName.toLowerCase());

                const borderClass = isCritical ? "border-red-300 ring-2 ring-red-50 shadow-red-100" : "border-slate-100 hover:border-indigo-200";
                const bgClass = isCritical ? "bg-red-50/30" : "bg-white";

                // Badge Logic
                let badge = "";
                if (isCritical) {
                    badge = `<span class="absolute -top-3 right-4 bg-red-500 text-white text-[10px] font-black uppercase tracking-wider px-3 py-1 rounded-full shadow-sm z-10">Critical Review</span>`;
                }

                return `
                    <div onclick="openStudyContent('${slug}', '${title}', '${grade}', '${subject}')"
                         class="relative group ${bgClass} p-6 rounded-3xl border ${borderClass} shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 cursor-pointer flex flex-col justify-between min-h-[160px]">
                        ${badge}

                        <div class="mb-4">
                            <div class="w-12 h-12 rounded-2xl ${isCritical ? 'bg-red-100 text-red-500' : 'bg-indigo-50 text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white'} flex items-center justify-center transition-colors duration-300 mb-4 shadow-inner">
                                <i class="fas fa-book-open text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-lg leading-tight group-hover:text-indigo-700 transition-colors">${title}</h4>
                        </div>

                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-50">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Base Camp</span>
                            <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center text-slate-300 group-hover:border-indigo-200 group-hover:text-indigo-500 transition shadow-sm">
                                <i class="fas fa-arrow-right text-xs"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join("");

            // Don't show header if it's "General" (cleaner UI) unless it's mixed content
            const header = category !== "General" ? `
                <h3 class="text-lg font-black text-slate-900 mb-6 flex items-center gap-3">
                    <span class="w-2 h-8 rounded-full bg-indigo-500"></span>
                    ${category}
                </h3>` : "";

            return `
                <div class="mb-12 animate-fade-in-up">
                    ${header}
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${grid}
                    </div>
                </div>
            `;
        }

        window.openStudyContent = (slug, title, grade, subject) => {
            // Navigate to Study Content
            const url = `study-content.html?chapter=${encodeURIComponent(title)}&slug=${encodeURIComponent(slug)}&subject=${encodeURIComponent(subject)}&grade=${grade}`;
            window.location.href = url;
        };

        // Init
        console.log("Initializing Auth Listener for Library...");
        initializeAuthListener((user) => {
            if (user) {
                loadSelection(user);
            } else {
                 window.location.href = "../index.html";
            }
        });
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto fade-in">
        <header class="flex items-center justify-between mb-10">
            <div class="flex items-center gap-4">
                <a id="back-link" href="#" class="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-900 hover:border-slate-400 transition shadow-sm">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 id="page-title" class="text-3xl font-black text-slate-900 tracking-tight">Library</h1>
                    <p class="text-slate-500 font-medium">Review concepts before testing.</p>
                </div>
            </div>
            <div class="hidden md:block">
                 <div class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-bold text-slate-600">
                    <i class="fas fa-layer-group text-indigo-500"></i>
                    <span>Study Mode Active</span>
                 </div>
            </div>
        </header>

        <div id="content-area">
            <!-- Dynamic Content -->
            <div class="flex flex-col items-center justify-center h-64 space-y-4">
                <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin"></div>
                <div class="font-bold text-slate-400 animate-pulse">Fetching Base Camp Data...</div>
            </div>
        </div>
    </div>
</body>
</html>
