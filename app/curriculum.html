<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4EFDM0CRYY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4EFDM0CRYY');
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Select Book & Chapter</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{
        extend:{
          fontFamily:{sans:['Inter','sans-serif']},
          colors:{'cbse-blue':'#1a3e6a','cbse-light':'#f5f7fa','accent-gold':'#ffb703'}
        }
      }
    }
  </script>

  <style>
    .topic-btn{
      width:100%;padding:1rem;margin-bottom:.75rem;border-radius:.75rem;background:#fff;
      border:1px solid #d1d5db;cursor:pointer;text-align:left;box-shadow:0 2px 6px rgba(2,6,23,.05);transition:.2s;
    }
    .topic-btn:hover{background:#f5f7fa; transform: translateY(-1px);}
    .topic-btn.selected{border-color:#1a3e6a;background:#eff6ff;ring:2px solid #1a3e6a; position: relative;}

    /* Checkmark for selected */
    .topic-btn.selected::after {
        content: '✓';
        position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
        font-weight: 900; color: #1a3e6a;
    }

    .difficulty-btn{
      padding:.6rem 1.25rem;border-radius:.75rem;font-weight:600;cursor:pointer;transition:.2s;
      opacity: 0.8;
    }
    .difficulty-btn:hover{opacity: 1;}
    .difficulty-btn.selected{opacity: 1; box-shadow:0 6px 18px rgba(26,62,106,.2); transform: scale(1.05);}
  </style>

  <script src="../js/config.js" type="module"></script>
</head>

<body class="bg-cbse-light min-h-screen flex flex-col">

<header class="bg-cbse-blue py-4 shadow-lg">
  <div class="max-w-6xl mx-auto flex justify-between items-center px-6">
    <h1 class="text-2xl font-extrabold text-accent-gold">Ready4<span class="text-white">Exam</span></h1>
    <button onclick="history.back()" class="text-white underline">← Back</button>
  </div>
</header>

<main class="flex-grow max-w-3xl mx-auto px-4 py-8 w-full">
  <div class="flex items-center justify-center gap-2 mb-2">
      <h2 id="page-title" class="text-3xl font-extrabold text-cbse-blue text-center">Select Book</h2>
      <span id="mode-badge" class="hidden bg-accent-gold text-cbse-blue text-[10px] font-black uppercase px-2 py-1 rounded-full">Term Prep Mode</span>
  </div>
  <p id="subject-desc" class="text-center text-gray-600 mb-8 font-medium"></p>

  <!-- Loading State -->
  <div id="loader" class="text-center py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cbse-blue mx-auto"></div>
      <p class="mt-4 text-gray-500">Loading Curriculum...</p>
  </div>

  <div id="content-container" class="space-y-2 mb-8 hidden"></div>

  <div id="difficulty-container" class="hidden mb-10 p-6 bg-white rounded-xl shadow-sm border border-gray-100 text-center">
    <h3 class="text-xl font-bold text-cbse-blue mb-4">Choose Difficulty Level</h3>
    <div class="flex flex-wrap justify-center gap-4">
      <button data-diff="Simple"   class="difficulty-btn bg-green-600 text-white">Simple</button>
      <button data-diff="Medium"   class="difficulty-btn bg-yellow-500 text-white">Medium</button>
      <button data-diff="Advanced" class="difficulty-btn bg-red-600 text-white">Advanced</button>
    </div>
  </div>

  <p id="error-msg" class="hidden text-center text-red-500 mb-4 font-semibold"></p>

  <div class="text-center sticky bottom-6 md:static">
    <button id="start-quiz" disabled
      class="w-full md:w-auto px-12 py-4 bg-cbse-blue text-white rounded-xl font-bold text-lg hover:bg-blue-800 transition shadow-lg disabled:opacity-40 disabled:cursor-not-allowed">
      Start Quiz
    </button>
  </div>
</main>

<footer class="bg-cbse-blue py-6 text-center text-white mt-12">
  <small>© 2025 Ready4Exam Academic Portal</small>
</footer>

<script type="module">
import { transliterate as tr } from "https://cdn.jsdelivr.net/npm/transliteration/+esm";
import { requireAuth } from "../js/auth-paywall.js";
import { checkClassAccess, showExpiredPopup } from "../js/firebase-expiry.js";
import { loadCurriculum, getGradeFromURL } from "../js/curriculum/loader.js";

// Initialize Constants
const CLASS_ID = getGradeFromURL();
const params = new URLSearchParams(location.search);
const subject  = params.get("subject") || "Physics"; // Default if missing
const isTermPrep = params.get("mode") === "term_prep";

// DOM Elements
const content      = document.getElementById("content-container");
const loader       = document.getElementById("loader");
const diffBox      = document.getElementById("difficulty-container");
const startBtn     = document.getElementById("start-quiz");
const errorMsg     = document.getElementById("error-msg");
const subjectDesc  = document.getElementById("subject-desc");
const modeBadge    = document.getElementById("mode-badge");

// Configure Mode UI
if (isTermPrep) {
    modeBadge.classList.remove("hidden");
    startBtn.textContent = "Proceed to Prep";
}

let curriculumData = null;
let selectedBook = null;
let selectedChapter = null; // Single select
let selectedChapters = new Set(); // Multi select
let selectedDifficulty = null;

const meta = {
  Physics: "Explore mechanics, waves & thermodynamics.",
  Chemistry: "Atoms, reactions, bonding & periodicity.",
  Biology: "Cells, plants, human body & ecosystems.",
  Mathematics: "Numbers, algebra, geometry & graphs.",
  Hindi: "हिंदी साहित्य और व्याकरण का अभ्यास करें।",
  English: "Literature, poetry, and grammar.",
  "Social Science": "History, Geography, Civics, and Economics."
};
subjectDesc.textContent = meta[subject] || `Explore ${subject} chapters.`;

// Load Curriculum
async function init() {
    try {
        curriculumData = await loadCurriculum(CLASS_ID);
        loader.classList.add("hidden");
        content.classList.remove("hidden");
        renderBooks();
    } catch (e) {
        loader.innerHTML = `<p class="text-red-500">Error loading curriculum: ${e.message}</p>`;
    }
}

function renderBooks(){
  const data = curriculumData[subject];
  document.getElementById("page-title").textContent = `Select Book (Class ${CLASS_ID})`;

  if (!data) {
    content.innerHTML = "<p class='text-center text-gray-500'>No data available for this subject.</p>";
    return;
  }

  const fragment = document.createDocumentFragment();
  Object.keys(data).forEach(book => {
    const btn = document.createElement("button");
    btn.className = "topic-btn font-semibold text-lg";
    btn.textContent = book;
    btn.onclick = () => renderChapters(book);
    fragment.appendChild(btn);
  });

  content.innerHTML = "";
  content.appendChild(fragment);
  diffBox.classList.add("hidden");
  startBtn.disabled = true;
}

function renderChapters(book){
  selectedBook = book;
  const chapters = curriculumData[subject][book];
  document.getElementById("page-title").textContent = book;

  const fragment = document.createDocumentFragment();

  // Back Button
  const back = document.createElement("button");
  back.className = "w-full text-cbse-blue font-bold py-2 mb-2 hover:underline text-left pl-2";
  back.textContent = "← Back to Books";
  back.onclick = renderBooks;
  fragment.appendChild(back);

  chapters.forEach(ch => {
    const title = ch.chapter_title || ch.title || ch;
    const btn = document.createElement("button");
    btn.className = "topic-btn";

    if (isTermPrep && selectedChapters.has(title)) {
        btn.classList.add("selected");
    }

    btn.textContent = title;
    btn.onclick = (e) => selectChapter(title, e.currentTarget);
    fragment.appendChild(btn);
  });

  content.innerHTML = "";
  content.appendChild(fragment);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function selectChapter(title, button){
  if (isTermPrep) {
      if (selectedChapters.has(title)) {
          selectedChapters.delete(title);
          button.classList.remove("selected");
      } else {
          selectedChapters.add(title);
          button.classList.add("selected");
      }

      if (selectedChapters.size > 0) {
          diffBox.classList.remove("hidden");
          errorMsg.classList.add("hidden");
      } else {
          diffBox.classList.add("hidden");
          startBtn.disabled = true;
      }
  } else {
      document.querySelectorAll(".topic-btn").forEach(b => b.classList.remove("selected"));
      button.classList.add("selected");

      selectedChapter = title;
      diffBox.classList.remove("hidden");

      setTimeout(() => {
        diffBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
  }
}

document.querySelectorAll(".difficulty-btn").forEach(btn => {
  btn.onclick = e => {
    document.querySelectorAll(".difficulty-btn").forEach(x => x.classList.remove("selected"));
    e.target.classList.add("selected");
    selectedDifficulty = e.target.dataset.diff;

    // Check if chapters are selected
    if (isTermPrep && selectedChapters.size === 0) return;
    if (!isTermPrep && !selectedChapter) return;

    startBtn.disabled = false;
    errorMsg.classList.add("hidden");
  };
});

function buildTableName(chapter){
  let chapterSlug = tr(chapter || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  const skip = ["as","of","the","a","an","in","on","for","to","ki","ke","ka"];
  const words = chapterSlug.split(" ").filter(w => !skip.includes(w));

  const first = words[0] || "ch";
  const last  = words[words.length - 1] || "x";

  let subjectSlug = tr(subject)
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")
    .split(" ")[0] || "sub";

  return `${subjectSlug}_${first}_${last}_${CLASS_ID}_quiz`;
}

startBtn.onclick = async () => {
  const hasSelection = isTermPrep ? selectedChapters.size > 0 : !!selectedChapter;

  if (!hasSelection || !selectedDifficulty) {
    errorMsg.textContent = "Please select chapter(s) and difficulty.";
    errorMsg.classList.remove("hidden");
    return;
  }

  try {
    const user = await requireAuth();
    startBtn.disabled = true;
    const originalText = startBtn.textContent;
    startBtn.textContent = "Verifying Scholar Status...";

    const access = await checkClassAccess(CLASS_ID, subject);

    if (access.allowed) {

      if (isTermPrep) {
          // TERM PREP FLOW
          const tables = Array.from(selectedChapters).map(ch => buildTableName(ch)).join(",");
          // Keep raw names for display
          const names = Array.from(selectedChapters).join(",");

          const params = new URLSearchParams({
            class: CLASS_ID,
            subject,
            chapters: tables,
            chapter_names: names,
            difficulty: selectedDifficulty,
            mode: "term_prep"
          });

          location.href = `cognitive-priming.html?${params.toString()}`;

      } else {
          // STANDARD FLOW
          const table = buildTableName(selectedChapter);
          const params = new URLSearchParams({
            class: CLASS_ID,
            subject,
            book: selectedBook,
            chapter: selectedChapter,
            difficulty: selectedDifficulty,
            table,
            chapter_name: selectedChapter
          });

          // Redirect to Generalized Quiz Engine
          location.href = `quiz-engine.html?${params.toString()}`;
      }

    } else {
      showExpiredPopup(access.reason);
      startBtn.disabled = false;
      startBtn.textContent = originalText;
    }

  } catch (err) {
    console.error("Auth or Access failed:", err);
    startBtn.disabled = false;
    startBtn.textContent = isTermPrep ? "Proceed to Prep" : "Start Quiz";
  }
};

// Start
init();

</script>
</body>
</html>
