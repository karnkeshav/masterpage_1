<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Console — Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script src="../../js/firebase-master-config.js"></script>
    <script src="../../js/config.js" type="module"></script>

    <script type="module">
        import { guardConsole } from "../../js/guard.js";
        import { signOut } from "../../js/auth-paywall.js";

        // LOGOUT LOGIC
        const logoutBtn = document.getElementById('logout-btn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                if (confirm("Sign out of your Ready4Exam session?")) {
                    try {
                        await signOut();
                        window.location.href = "../../index.html";
                    } catch (err) {
                        console.error("Logout failed", err);
                    }
                }
            });
        }

        // GLOBAL GUARD
        guardConsole("parent");

        window.loadConsoleData = async (profile) => {
            console.log("Loading Parent Console for:", profile.uid);

            // Constraint: Strictly isolate to child's user_id
            // In a real implementation, we would fetch profile.linked_children
            // For now, we simulate finding the child
            const childName = "Aarav"; // Mock

            document.getElementById("child-name").textContent = childName;
            renderGrowthChart();
        };

        function renderGrowthChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Grade 6', 'Grade 7', 'Grade 8', 'Grade 9'],
                    datasets: [{
                        label: 'Science Mastery',
                        data: [72, 78, 85, 92],
                        borderColor: '#2563eb',
                        backgroundColor: '#2563eb',
                        tension: 0.4
                    }, {
                        label: 'Math Mastery',
                        data: [65, 70, 72, 88],
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
    <nav class="fixed top-0 right-0 p-4 z-50">
        <button id="logout-btn" class="flex items-center gap-2 px-4 py-2 bg-slate-900/50 backdrop-blur-md border border-slate-700 hover:bg-red-600 hover:border-red-500 text-white text-sm font-bold rounded-xl transition-all duration-300 shadow-lg">
            <i class="fas fa-sign-out-alt text-red-400"></i>
            <span>Sign Out</span>
        </button>
    </nav>

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="animate-pulse font-bold text-slate-400">Verifying Parental Access...</div>
    </div>

    <div id="app" class="hidden max-w-5xl mx-auto p-4 md:p-8 fade-in">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2">Guardian<span class="text-blue-600">Link</span></h1>
                <p class="text-slate-500 font-medium">Monitoring Progress for <span id="child-name" class="text-slate-900 font-bold">Child</span>.</p>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="font-bold text-slate-900 mb-6">Longitudinal Growth (Grades 6-12)</h3>
                <canvas id="growthChart"></canvas>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm overflow-hidden relative">
                 <h3 class="font-bold text-slate-900 mb-6">Live Evidence Feed</h3>
                 <div class="space-y-6 relative z-10">
                     <div class="flex gap-4">
                         <div class="flex-shrink-0 w-2 h-full bg-slate-100 rounded-full mx-auto relative">
                             <div class="absolute top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-green-500 rounded-full border-4 border-white"></div>
                         </div>
                         <div class="pb-6">
                             <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Today, 10:42 AM</div>
                             <div class="font-bold text-slate-900">Mastered "Force and Laws of Motion"</div>
                             <div class="text-sm text-slate-500 mt-1">Score: 92% • Difficulty: Advanced</div>
                         </div>
                     </div>
                     <div class="flex gap-4">
                         <div class="flex-shrink-0 w-2 h-full bg-slate-100 rounded-full mx-auto relative">
                             <div class="absolute top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-amber-400 rounded-full border-4 border-white"></div>
                         </div>
                         <div class="pb-6">
                             <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Yesterday</div>
                             <div class="font-bold text-slate-900">Attempted "Polynomials"</div>
                             <div class="text-sm text-slate-500 mt-1">Score: 65% • Triggered Remedial Loop</div>
                         </div>
                     </div>
                 </div>

                 <!-- Connector Line Hack -->
                 <div class="absolute top-20 left-[2.4rem] w-0.5 h-40 bg-slate-100 -z-0"></div>
            </div>
        </div>
    </div>
</body>
</html>
