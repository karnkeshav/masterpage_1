<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Console â€” Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script src="../../js/config.js" type="module"></script>
</head>
<body class="bg-white text-slate-800 min-h-screen">

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="animate-pulse font-bold text-slate-400">Loading your Portfolio...</div>
    </div>

    <div id="app" class="hidden max-w-7xl mx-auto p-6 fade-in">
        <header class="flex justify-between items-end mb-8 pb-6 border-b border-slate-100">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-2">My Learning<span class="text-blue-600">Map</span></h1>
                <p class="text-slate-500 font-medium">Welcome back, <span id="user-name" class="text-slate-900 font-bold">Student</span>.</p>
            </div>
            <div class="flex gap-4">
                 <a href="../review.html" class="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition">
                    <i class="fas fa-exclamation-triangle"></i> Mistake Notebook
                </a>
                <div class="hidden md:block text-right">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Current Grade</div>
                    <div id="grade-display" class="text-lg font-bold text-slate-900">Class 9</div>
                </div>
            </div>
        </header>

        <div id="dependency-graph">
            <!-- Injected -->
        </div>

    </div>

    <script type="module">
        import { initializeAuthListener, requireAuth } from "../../js/auth-paywall.js";
        import { getInitializedClients } from "../../js/config.js";
        import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { loadCurriculum } from "../../js/curriculum/loader.js";

        async function init(user) {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            document.getElementById("user-name").textContent = user.displayName || "Student";

            // Determine Grade
            let grade = "9";
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("grade")) {
                grade = urlParams.get("grade");
            } else {
                // Try to get from user profile
                const { db } = getInitializedClients();
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    // Find active class
                    const active = Object.keys(data.paidClasses || {}).find(k => data.paidClasses[k]);
                    if (active) grade = active;
                }
            }

            document.getElementById("grade-display").textContent = `Class ${grade}`;

            // Load Curriculum & Progress
            try {
                const curriculum = await loadCurriculum(grade);
                await loadProgress(user, curriculum, grade);
            } catch (e) {
                console.error(e);
                document.getElementById("dependency-graph").innerHTML = `<p class="text-red-500">Failed to load data.</p>`;
            }
        }

        async function loadProgress(user, curriculum, grade) {
            const { db } = getInitializedClients();
            const q = query(collection(db, "quiz_scores"), where("user_id", "==", user.uid));

            try {
                const snap = await getDocs(q);
                const scores = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    scores[d.chapter] = scores[d.chapter] || [];
                    scores[d.chapter].push(d);
                });
                renderGraph(scores, curriculum, grade);
            } catch (e) {
                console.error("Error loading progress:", e);
            }
        }

        function renderGraph(scores, curriculum, grade) {
            const container = document.getElementById("dependency-graph");
            let html = "";

            // Subjects
            const subjects = ["Science", "Mathematics", "Social Science", "English"];

            subjects.forEach(sub => {
                const subData = curriculum[sub];
                if(!subData) return;

                html += `
                <div class="mb-12">
                    <h3 class="text-xl font-black text-slate-900 mb-6 flex items-center gap-2">
                        <span class="bg-blue-100 w-8 h-8 rounded-lg flex items-center justify-center text-blue-600 text-sm">
                            <i class="fas fa-book"></i>
                        </span>
                        ${sub}
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">`;

                Object.keys(subData).forEach(book => {
                    subData[book].forEach(ch => {
                        const name = ch.chapter_title || ch.title || ch;

                        // Try to find score
                        let best = 0;
                        let status = "unattempted";

                        // Naive match
                        if (scores[name]) {
                             const attempts = scores[name];
                             best = attempts.reduce((max, a) => Math.max(max, a.percentage || ((a.score/a.total)*100)), 0);
                        } else {
                             const key = Object.keys(scores).find(k => k.toLowerCase() === name.toLowerCase());
                             if (key) {
                                 const attempts = scores[key];
                                 best = attempts.reduce((max, a) => Math.max(max, a.percentage || ((a.score/a.total)*100)), 0);
                             }
                        }

                        // Brick Style
                        let bg = "bg-slate-50";
                        let border = "border-slate-200";
                        let text = "text-slate-400";
                        let icon = "fa-lock";

                        if (best > 0) {
                            if (best >= 85) {
                                status = "mastered";
                                bg = "bg-emerald-500";
                                border = "border-emerald-700";
                                text = "text-white";
                                icon = "fa-star";
                            } else {
                                status = "in-progress";
                                bg = "bg-amber-400";
                                border = "border-amber-600";
                                text = "text-amber-900";
                                icon = "fa-bolt";
                            }
                        }

                        html += `
                            <div class="${bg} ${text} ${border} border-b-4 rounded-xl p-4 h-32 flex flex-col justify-between relative overflow-hidden transition hover:scale-105 shadow-sm group cursor-pointer" onclick="goToChapter('${grade}', '${sub}')">
                                <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition transform group-hover:rotate-12">
                                    <i class="fas ${icon} text-4xl"></i>
                                </div>
                                <span class="text-xs font-bold leading-tight relative z-10 line-clamp-3">${name}</span>
                                <div class="relative z-10">
                                    <div class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-1">
                                        ${status === 'unattempted' ? 'Locked' : status}
                                    </div>
                                    <div class="h-1 w-full bg-black/10 rounded-full overflow-hidden">
                                        <div class="h-full bg-white/80" style="width: ${best}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;
        }

        window.goToChapter = (grade, subject) => {
             location.href = `../../app/curriculum.html?grade=${grade}&subject=${encodeURIComponent(subject)}`;
        };

        window.doLogin = async () => {
            await requireAuth();
            location.reload();
        };

        initializeAuthListener(user => {
            if(user) {
                init(user);
            } else {
                document.getElementById("loading").innerHTML = `
                    <button onclick="doLogin()" class="bg-cbse-blue text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-800">
                        Sign In to View Portfolio
                    </button>`;
            }
        });
    </script>
</body>
</html>
