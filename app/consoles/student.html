<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Hub ‚Äî Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily:{ sans:['Inter','sans-serif'] },
          colors:{
            'cbse-blue':'#1a3e6a',
            'cbse-light':'#f5f7fa',
            'accent-gold':'#ffb703',
            'success-green': '#16a34a',
            'warning-yellow': '#ca8a04',
            'danger-red': '#dc2626'
          }
        }
      }
    }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script src="../../js/firebase-master-config.js"></script>
    <script src="../../js/config.js" type="module"></script>

    <script type="module">
        import { guardConsole, bindConsoleLogout } from "../../js/guard.js";
        import { getInitializedClients } from "../../js/config.js";
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import * as UI from "../../js/ui-renderer.js";

        UI.injectStyles();
        bindConsoleLogout("logout-nav-btn", "../../index.html");
        guardConsole("student");

        window.loadConsoleData = async (profile) => {
            const grade = profile.classId || "9";
            document.getElementById("user-welcome").textContent = profile.displayName || "Scholar";
            document.getElementById("context-badge").textContent = `Grade ${grade}`;
            document.getElementById("class-title").textContent = `Class ${grade} Hub`;
            
            setupNavigation(grade);
            await renderMentorHub(profile.uid, grade);
            
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
        };

        function setupNavigation(grade) {
            // Restore high-impact action card links
            document.getElementById("btn-start-test").href = `../curriculum.html?grade=${grade}`;
            document.getElementById("btn-mistakes-hub").href = `../mistake-book.html`;
            
            // Sidebar Room Links
            document.getElementById("btn-library").href = `../study-library.html?grade=${grade}`;
            document.getElementById("btn-warmup").href = `../curriculum.html?grade=${grade}`;

            // Subject Shortcuts (Routing to Study Library)
            document.querySelectorAll(".subject-shortcut").forEach(btn => {
                btn.onclick = () => {
                    const subject = btn.dataset.subject;
                    window.location.href = `../study-library.html?grade=${grade}&subject=${encodeURIComponent(subject)}`;
                };
            });
        }

        async function renderMentorHub(uid, grade) {
            const { db } = await getInitializedClients();
            const q = query(collection(db, "quiz_scores"), where("user_id", "==", uid), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);

            if (snap.empty) {
                renderZeroState();
                return;
            }

            const scores = snap.docs.map(doc => doc.data());

            // 1. Horizontal Subject Health Meters
            renderSubjectHealth(scores);

            // 2. Chapter Health Status Grid (with Grit Tracking)
            renderChapterHealth(scores);

            // 3. Automated Mentor Insights
            renderMentorAdvice(scores);
        }

        function renderSubjectHealth(scores) {
            const subjects = ["Mathematics", "Science", "Social Science"];
            const container = document.getElementById("subject-health-meters");
            container.innerHTML = subjects.map(sub => {
                const subScores = scores.filter(s => normalizeSubject(s) === sub);
                const avg = subScores.length > 0 
                    ? Math.round(subScores.reduce((a, b) => a + (b.score_percent || 0), 0) / subScores.length) 
                    : 0;
                
                const colorClass = avg >= 85 ? 'bg-success-green' : avg >= 50 ? 'bg-cbse-blue' : 'bg-danger-red';
                
                return `
                    <div class="mb-6 last:mb-0">
                        <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                            <span class="text-slate-500">${sub}</span>
                            <span class="text-slate-900">${avg}%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden shadow-inner">
                            <div class="${colorClass} h-full transition-all duration-1000" style="width: ${avg}%"></div>
                        </div>
                    </div>`;
            }).join("");
        }

        function renderChapterHealth(scores) {
            const chapters = {};
            scores.forEach(s => {
                const name = formatChapterName(s.topicSlug || s.topic);
                if (!chapters[name]) chapters[name] = { max: 0, attempts: 0 };
                chapters[name].attempts++;
                if ((s.score_percent || 0) > chapters[name].max) chapters[name].max = s.score_percent;
            });

            const grid = document.getElementById("chapter-health-grid");
            grid.innerHTML = Object.entries(chapters).slice(0, 6).map(([name, data]) => {
                const status = data.max >= 85 ? 'Mastered' : data.max >= 50 ? 'Improving' : 'Needs Focus';
                const textColor = data.max >= 85 ? 'text-success-green' : data.max >= 50 ? 'text-cbse-blue' : 'text-danger-red';
                
                return `
                    <div class="glass-panel p-4 rounded-2xl border border-slate-100 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[9px] font-black uppercase ${textColor}">${status}</span>
                                <span class="text-[9px] font-bold text-slate-400">Grit: ${data.attempts}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 text-sm truncate">${name}</h4>
                        </div>
                        <div class="text-2xl font-black mt-2 text-slate-900">${data.max}%</div>
                    </div>`;
            }).join("");
        }

        function renderMentorAdvice(scores) {
            const latest = scores[0];
            const adviceContainer = document.getElementById("advice-box");
            let tip = "";

            if (latest.score_percent < 50) {
                tip = `You're struggling with <b>${formatChapterName(latest.topic)}</b>. Don't worry‚Äîvisit the <b>Base Camp</b> to master formulas and core takeaways before testing again.`;
            } else if (latest.score_percent < 85) {
                tip = `Great progress in <b>${formatChapterName(latest.topic)}</b>! You're in the "Improving" phase. Review the Glossary in the Base Camp to hit <b>Expert Level</b>.`;
            } else {
                tip = `Your Chapter Health is optimal! Explore a new subject card or tackle a higher difficulty in the Warm-up Room.`;
            }

            adviceContainer.innerHTML = `
                <div class="p-4 bg-white rounded-2xl border border-cbse-blue/10 shadow-sm flex gap-3">
                    <div class="text-xl">üí°</div>
                    <p class="text-xs text-slate-600 leading-relaxed"><strong>Mentor Insight:</strong> ${tip}</p>
                </div>`;
        }

        function normalizeSubject(data) {
            const ctx = `${data.subject || ''} ${data.topicSlug || ''}`.toLowerCase();
            if (ctx.includes("math")) return "Mathematics";
            if (ctx.includes("science")) return "Science";
            return "Social Science";
        }

        function formatChapterName(slug) {
            if (!slug) return "General Quiz";
            return slug.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderZeroState() {
            document.getElementById("app").innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <div class="text-6xl mb-6">üöÄ</div>
                    <h2 class="text-2xl font-black text-slate-800 mb-2">Welcome Scholar!</h2>
                    <p class="text-slate-500 max-w-sm mb-8">Begin your first learning journey to activate your performance health meters.</p>
                    <a href="../curriculum.html" class="px-8 py-4 bg-cbse-blue text-white font-bold rounded-2xl shadow-xl hover:scale-105 transition">Start New Quiz</a>
                </div>`;
        }
    </script>
</head>
<body class="bg-cbse-light min-h-screen flex flex-col">

    <header class="glass-panel sticky top-0 z-50 flex justify-between items-center py-4 px-6 border-b border-white/20">
      <div class="flex items-center space-x-4">
        <a href="../../index.html" class="w-10 h-10 flex items-center justify-center bg-white text-cbse-blue font-bold rounded-2xl shadow-sm hover:scale-105 transition active:scale-95 text-lg">üè†</a>
        <div>
          <h2 id="class-title" class="text-xl font-black text-cbse-blue leading-none tracking-tight">Class Hub</h2>
          <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Ready4Exam Performance Hub</p>
        </div>
      </div>

      <div class="flex items-center space-x-3">
          <div class="hidden md:flex items-center gap-3 mr-4 border-r border-slate-200 pr-4">
            <a id="btn-start-test" href="#" class="px-4 py-2 bg-cbse-blue text-white text-[11px] font-black rounded-xl hover:shadow-lg transition">START NEW QUIZ</a>
            <a id="btn-mistakes-hub" href="#" class="px-4 py-2 bg-red-50 text-danger-red text-[11px] font-black rounded-xl border border-red-100 hover:bg-red-500 hover:text-white transition">MISTAKE BOOK</a>
          </div>
          <div class="hidden md:flex flex-col items-end mr-2">
              <span id="user-welcome" class="text-xs font-bold text-slate-700">Student</span>
              <span id="context-badge" class="text-[10px] font-black text-accent-gold bg-cbse-blue px-2 py-0.5 rounded uppercase tracking-wide">Grade --</span>
          </div>
          <button id="logout-nav-btn" class="w-10 h-10 flex items-center justify-center bg-red-50 text-red-500 rounded-2xl hover:bg-red-500 hover:text-white transition shadow-sm">üö™</button>
      </div>
    </header>

    <div id="loading" class="flex items-center justify-center flex-grow">
        <div class="animate-pulse font-bold text-slate-400">Syncing Mentor Hub...</div>
    </div>

    <main id="app" class="hidden max-w-6xl mx-auto w-full p-4 md:p-8 space-y-8 fade-in">
        
        <div class="grid lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-panel p-6 rounded-3xl shadow-sm">
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-6">Subject Health Meters</h3>
                    <div id="subject-health-meters">
                        </div>
                </div>

                <div id="advice-box">
                    </div>

                <div class="space-y-4">
                    <a id="btn-library" href="#" class="group flex items-center gap-4 p-4 glass-panel rounded-2xl hover:bg-indigo-50 transition border border-transparent hover:border-indigo-100">
                        <div class="w-10 h-10 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg shadow-sm">üìö</div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">Study Library</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">NCERT Base Camps</p>
                        </div>
                    </a>
                    <a id="btn-warmup" href="#" class="group flex items-center gap-4 p-4 glass-panel rounded-2xl hover:bg-amber-50 transition border border-transparent hover:border-amber-100">
                        <div class="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center text-lg shadow-sm">‚ö°</div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">Warm-up Room</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Priming & Selection</p>
                        </div>
                    </a>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                
                <div class="space-y-4">
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest px-1">Chapter Health Status</h3>
                    <div id="chapter-health-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        </div>
                </div>

                <div class="pt-4">
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest px-1 mb-6">Deep Learning Library</h3>
                    <div class="flex justify-between items-center px-2">
                        <button class="subject-shortcut group flex flex-col items-center gap-2" data-subject="Mathematics">
                            <div class="w-16 h-16 rounded-3xl bg-blue-50 border border-blue-100 flex items-center justify-center text-blue-600 shadow-sm group-hover:scale-110 transition group-hover:bg-cbse-blue group-hover:text-white">
                                <i class="fas fa-calculator text-xl"></i>
                            </div>
                            <span class="text-[11px] font-black text-slate-600 uppercase">Math</span>
                        </button>
                        <button class="subject-shortcut group flex flex-col items-center gap-2" data-subject="Science">
                            <div class="w-16 h-16 rounded-3xl bg-purple-50 border border-purple-100 flex items-center justify-center text-purple-600 shadow-sm group-hover:scale-110 transition group-hover:bg-purple-600 group-hover:text-white">
                                <i class="fas fa-atom text-xl"></i>
                            </div>
                            <span class="text-[11px] font-black text-slate-600 uppercase">Science</span>
                        </button>
                        <button class="subject-shortcut group flex flex-col items-center gap-2" data-subject="Social Science">
                            <div class="w-16 h-16 rounded-3xl bg-amber-50 border border-amber-100 flex items-center justify-center text-amber-600 shadow-sm group-hover:scale-110 transition group-hover:bg-amber-600 group-hover:text-white relative">
                                <i class="fas fa-globe-americas text-xl"></i>
                                <span class="absolute -top-1 -right-1 w-5 h-5 bg-danger-red text-white text-[8px] font-black flex items-center justify-center rounded-full border-2 border-white animate-pulse shadow-md">3</span>
                            </div>
                            <span class="text-[11px] font-black text-slate-600 uppercase">SST</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="bg-cbse-blue text-white/50 text-[10px] md:text-xs text-center py-10 mt-auto border-t border-white/5">
      <p class="font-black tracking-widest uppercase mb-2">Ready4Exam Academic Portal</p>
      <p class="opacity-70">Powered by the Cognition & Mastery Engine ‚Ä¢ ¬© 2025</p>
    </footer>

</body>
</html>
