<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curriculum â€” Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script src="../js/firebase-master-config.js"></script>
    <script src="../js/config.js" type="module"></script>

    <script type="module">
        import { loadCurriculum } from "../js/curriculum/loader.js";

        // --- HELPER: Transliterate to Table Name ---
        function buildTableName(chapterTitle, subject, grade) {
            const skipList = ["as","of","the","a","an","in","on","for","to","ki","ke","ka"];

            // 1. Clean Title
            let clean = chapterTitle.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
            let words = clean.split(/\s+/);

            // 2. Filter Skip Words
            words = words.filter(w => !skipList.includes(w));

            if (words.length === 0) words = ["chapter"]; // Fallback

            // 3. Extract First & Last
            const first = words[0];
            const last = words.length > 1 ? words[words.length - 1] : first;

            // 4. Subject Slug (First Word Only)
            const subjectSlug = subject.trim().split(" ")[0].toLowerCase();

            // 5. Return Format
            return `${subjectSlug}_${first}_${last}_${grade}_quiz`;
        }

        window.loadSelection = async () => {
            const params = new URLSearchParams(window.location.search);
            const grade = params.get("grade") || "9";
            const subject = params.get("subject") || "Science";

            document.getElementById("page-title").textContent = `${subject} (Class ${grade})`;
            document.getElementById("back-link").href = `consoles/student.html?grade=${grade}`; // Fallback if history empty

            try {
                const curriculum = await loadCurriculum(grade);
                const data = curriculum[subject];

                if (!data) {
                    document.getElementById("content-area").innerHTML = `<div class="text-center text-slate-400">No content found for ${subject}.</div>`;
                    return;
                }

                renderCurriculum(data, subject, grade);
            } catch (e) {
                console.error(e);
                document.getElementById("content-area").innerHTML = `<div class="text-center text-red-400">Failed to load curriculum.</div>`;
            }
        };

        function renderCurriculum(data, subject, grade) {
            const container = document.getElementById("content-area");
            let html = "";

            // Check structure: Array (Math/Science simple) or Object (Sub-categories)?
            // Curriculum loader returns object with keys like "Physics", "Chemistry" etc. for Science
            // Or "History", "Geography" for Social Science

            if (Array.isArray(data)) {
                // Flat list (Maybe Math in some grades?)
                // Treat as "General"
                html += renderSection("General", data, subject, grade);
            } else {
                // Categorized
                // Order keys if needed?
                Object.keys(data).forEach(category => {
                    html += renderSection(category, data[category], subject, grade);
                });
            }

            container.innerHTML = html;
        }

        function renderSection(category, chapters, subject, grade) {
            if (!chapters || !chapters.length) return "";

            const grid = chapters.map(ch => {
                const title = ch.chapter_title || ch.title || ch;
                // Generate Table ID
                // Note: In real app, table_name might be in the JSON. If not, generate it.
                // Assuming we generate it strictly based on title for now.
                // Or if the object has `table_name`, use it.
                const tableId = ch.table_id || ch.table_name || buildTableName(title, subject, grade);

                return `
                    <div onclick="startQuiz('${tableId}', '${title}', '${grade}')"
                         class="group bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:border-blue-500 hover:shadow-md transition cursor-pointer flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-600 transition">
                                <i class="fas fa-play text-xs"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition">${title}</h4>
                                <div class="text-xs text-slate-400 font-mono mt-1 opacity-50">${tableId}</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i>
                    </div>
                `;
            }).join("");

            return `
                <div class="mb-8">
                    <h3 class="text-lg font-black text-slate-900 mb-4 px-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        ${category}
                    </h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${grid}
                    </div>
                </div>
            `;
        }

        let selectedTableId = "";
        let selectedTitle = "";
        let selectedGrade = "";

        window.startQuiz = (tableId, title, grade) => {
            selectedTableId = tableId;
            selectedTitle = title;
            selectedGrade = grade;

            // Show Difficulty Modal
            document.getElementById("difficulty-modal").classList.remove("hidden");
        };

        window.proceedToQuiz = (difficulty) => {
            if (!selectedTableId) return;
            const url = `quiz-engine.html?table=${selectedTableId}&topic=${encodeURIComponent(selectedTitle)}&grade=${selectedGrade}&difficulty=${difficulty}`;
            window.location.href = url;
        };

        window.closeModal = () => {
             document.getElementById("difficulty-modal").classList.add("hidden");
        };

        // Init
        loadSelection();
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto fade-in">
        <header class="flex items-center gap-4 mb-8">
            <a id="back-link" href="#" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-900 hover:border-slate-400 transition">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 id="page-title" class="text-2xl font-black text-slate-900 tracking-tight">Loading...</h1>
                <p class="text-slate-500 text-sm font-medium">Select a chapter to begin mastery.</p>
            </div>
        </header>

        <div id="content-area">
            <!-- Dynamic Content -->
            <div class="flex items-center justify-center h-64">
                <div class="animate-pulse font-bold text-slate-300">Fetching Curriculum...</div>
            </div>
        </div>
    </div>

    <!-- Difficulty Modal -->
    <div id="difficulty-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all scale-100 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h3 class="text-xl font-black text-slate-900">Select Difficulty</h3>
                <p class="text-slate-500 text-sm mt-2">Choose your challenge level</p>
            </div>

            <div class="space-y-3">
                <button onclick="proceedToQuiz('Simple')" class="w-full py-3 px-4 rounded-xl border border-slate-200 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700 transition font-bold text-slate-700 flex items-center justify-between group">
                    <span>Simple</span>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500"></i>
                </button>
                <button onclick="proceedToQuiz('Medium')" class="w-full py-3 px-4 rounded-xl border border-slate-200 hover:border-purple-500 hover:bg-purple-50 hover:text-purple-700 transition font-bold text-slate-700 flex items-center justify-between group">
                    <span>Medium</span>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-purple-500"></i>
                </button>
                <button onclick="proceedToQuiz('Advanced')" class="w-full py-3 px-4 rounded-xl border border-slate-200 hover:border-orange-500 hover:bg-orange-50 hover:text-orange-700 transition font-bold text-slate-700 flex items-center justify-between group">
                    <span>Advanced</span>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-orange-500"></i>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
