<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistake Notebook ‚Äî Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script src="../js/firebase-master-config.js"></script>
    <script src="../js/config.js" type="module"></script>

    <script type="module">
        import { initializeAuthListener } from "../js/auth-paywall.js";
        import { getInitializedClients } from "../js/api.js";
        import { normalizeSubject, formatChapterName, cleanKatexMarkers } from "../js/utils.js";
        import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function loadMistakes(user) {
            const container = document.getElementById("mistakes-container");
            container.innerHTML = `<div class="text-center p-8 animate-pulse text-slate-400">Loading your learning journey...</div>`;

            try {
                const { db } = await getInitializedClients();

                // 1. Fetch Mistakes & Scores in Parallel
                const mistakesQ = query(
                    collection(db, "mistake_notebook"),
                    where("user_id", "==", user.uid),
                    orderBy("timestamp", "desc")
                );

                const scoresQ = query(
                    collection(db, "quiz_scores"),
                    where("user_id", "==", user.uid),
                    orderBy("timestamp", "desc") // Newest first
                );

                const [mistakesSnap, scoresSnap] = await Promise.all([
                    getDocs(mistakesQ),
                    getDocs(scoresQ)
                ]);

                if (mistakesSnap.empty) {
                    renderEmptyState(container);
                    return;
                }

                // 2. Process Scores for Chapter Mastery Status (History)
                // Map: ChapterName -> [ { score, date } ] (sorted new -> old)
                const chapterHistory = {};
                scoresSnap.forEach(doc => {
                    const data = doc.data();
                    const rawSlug = data.topicSlug || data.topic || data.chapter || "";
                    const chName = formatChapterName(rawSlug);
                    const score = data.percentage || data.score_percent || 0;

                    if (!chapterHistory[chName]) {
                        chapterHistory[chName] = [];
                    }
                    chapterHistory[chName].push({
                        score: score,
                        date: data.timestamp ? data.timestamp.toDate() : new Date()
                    });
                });

                // 3. Group Mistakes by Subject > Chapter
                // Structure: tree[Subject][Chapter] = [ { ...mistakeData, date } ]
                const tree = {};

                mistakesSnap.forEach(doc => {
                    const data = doc.data(); // mistake_notebook doc
                    const date = data.timestamp ? data.timestamp.toDate() : new Date();

                    // Normalize Subject
                    const subject = normalizeSubject({ topic: data.topic, subject: data.subject });
                    const chapter = formatChapterName(data.topic || data.chapter_slug);

                    if (!tree[subject]) tree[subject] = {};
                    if (!tree[subject][chapter]) tree[subject][chapter] = [];

                    // Add individual mistakes
                    (data.mistakes || []).forEach(m => {
                        tree[subject][chapter].push({
                            question: m.question,
                            selected: m.selected,
                            correct: m.correct,
                            explanation: m.explanation,
                            date: date,
                            originalSlug: data.topic // store for reference
                        });
                    });
                });

                // 4. Render Accordions
                renderTree(container, tree, chapterHistory);

            } catch (e) {
                console.error("Mistake Load Error:", e);
                container.innerHTML = `<div class="text-center text-red-500">Failed to load mistakes. Please try again.</div>`;
            }
        }

        function renderEmptyState(container) {
             container.innerHTML = `
                <div class="text-center p-12 bg-white rounded-3xl border border-dashed border-slate-300">
                    <div class="text-4xl mb-4">üéâ</div>
                    <h3 class="text-xl font-bold text-slate-700">No Mistakes Recorded!</h3>
                    <p class="text-slate-500">Keep practicing to find areas for improvement.</p>
                </div>
            `;
        }

        function renderTree(container, tree, chapterHistory) {
            let html = "";
            const subjects = Object.keys(tree).sort();

            subjects.forEach(subject => {
                const chapters = tree[subject];

                html += `<div class="mb-8">
                    <h2 class="text-2xl font-black text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-2 h-8 bg-blue-600 rounded-full"></span>
                        ${subject}
                    </h2>`;

                Object.keys(chapters).sort().forEach(chapter => {
                    const mistakes = chapters[chapter];
                    // Sort mistakes by date desc
                    mistakes.sort((a, b) => b.date - a.date);

                    // Determine Chapter Life Cycle based on History
                    const history = chapterHistory[chapter] || [];

                    let status = "Unresolved";
                    let statusColor = "bg-red-100 text-red-600";
                    let nudge = "";

                    // Logic:
                    // Mastered: Corrected (>=85%) in the last two consecutive attempts.
                    // Learning: Previously wrong, but corrected (>=85%) in the latest attempt.
                    // Unresolved: Latest attempt < 85% (or no attempts recorded if just mistakes exist).

                    const latestScore = history.length > 0 ? history[0].score : 0;
                    const prevScore = history.length > 1 ? history[1].score : 0;

                    if (history.length >= 2 && latestScore >= 85 && prevScore >= 85) {
                        status = "Mastered";
                        statusColor = "bg-emerald-100 text-emerald-600";
                    } else if (latestScore >= 85) {
                        status = "Learning";
                        statusColor = "bg-blue-100 text-blue-600";
                        nudge = "Earlier you were not aware of this, but now you are getting it right! Excellent progress.";
                    }

                    const uniqueId = `acc-${subject}-${chapter}`.replace(/\s+/g, '-');

                    html += `
                        <div class="mb-4 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <!-- Header / Trigger -->
                            <button onclick="toggleAccordion('${uniqueId}')" class="w-full flex items-center justify-between p-6 text-left hover:bg-slate-50 transition">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-900">${chapter}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide ${statusColor}">${status}</span>
                                        <span class="text-xs text-slate-400 font-medium">${mistakes.length} Issues Recorded</span>
                                    </div>
                                </div>
                                <i id="icon-${uniqueId}" class="fas fa-chevron-down text-slate-300 transition-transform duration-300"></i>
                            </button>

                            <!-- Content -->
                            <div id="${uniqueId}" class="hidden border-t border-slate-100 bg-slate-50/50">
                                <div class="p-6">
                                    <!-- Cognitive Nudge -->
                                    ${nudge ? `
                                        <div class="mb-6 p-4 bg-blue-50 border border-blue-100 rounded-xl flex items-start gap-3">
                                            <i class="fas fa-brain text-blue-500 mt-1"></i>
                                            <p class="text-sm text-blue-800 italic font-medium">"${nudge}"</p>
                                        </div>
                                    ` : ''}

                                    <!-- Victory Timeline -->
                                    <div class="mb-8 flex items-center gap-2 overflow-x-auto pb-2">
                                        ${mistakes.slice(0, 5).map(m => `
                                            <div class="flex-shrink-0 flex flex-col items-center">
                                                <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-xs font-bold mb-1">‚ùå</div>
                                                <div class="text-[10px] text-slate-400 font-mono">${m.date.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div>
                                            </div>
                                            <div class="w-8 h-0.5 bg-slate-200"></div>
                                        `).join('')}

                                        ${status === 'Mastered' ? `
                                            <div class="flex-shrink-0 flex flex-col items-center">
                                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs font-bold mb-1">‚úÖ</div>
                                                <div class="text-[10px] text-emerald-600 font-mono font-bold">Today</div>
                                            </div>
                                        ` : `
                                            <div class="flex-shrink-0 flex flex-col items-center opacity-50">
                                                <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-300 flex items-center justify-center text-xs font-bold mb-1">?</div>
                                                <div class="text-[10px] text-slate-300 font-mono">Next</div>
                                            </div>
                                        `}
                                    </div>

                                    <!-- Questions List -->
                                    <div class="space-y-6">
                                        ${mistakes.map((m, idx) => `
                                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm relative">
                                                <div class="absolute top-0 left-0 w-1 h-full rounded-l-xl ${status === 'Mastered' ? 'bg-emerald-400' : 'bg-red-400'}"></div>
                                                <div class="pl-4">
                                                    <h4 class="font-bold text-slate-900 text-base mb-3">${cleanKatexMarkers(m.question)}</h4>

                                                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                                                        <div class="p-3 bg-red-50 rounded-lg border border-red-100">
                                                            <div class="text-[10px] font-bold text-red-400 uppercase tracking-wide mb-1">You Selected</div>
                                                            <div class="font-bold text-sm text-red-900">${m.selected}</div>
                                                        </div>
                                                        <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                                                            <div class="text-[10px] font-bold text-green-600 uppercase tracking-wide mb-1">Correct Answer</div>
                                                            <div class="font-bold text-sm text-green-900">${m.correct}</div>
                                                        </div>
                                                    </div>

                                                    ${m.explanation ? `
                                                        <div class="text-sm text-slate-600 italic border-l-2 border-slate-300 pl-3">
                                                            <span class="font-bold not-italic text-slate-700">Note:</span> ${cleanKatexMarkers(m.explanation)}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`; // Close Subject div
            });

            container.innerHTML = html;
        }

        window.toggleAccordion = (id) => {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                el.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        // Init
        initializeAuthListener(async (user) => {
            if (user) {
                document.getElementById("student-name").textContent = user.displayName || "Scholar";
                await loadMistakes(user);
            } else {
                window.location.href = "../index.html";
            }
        });
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-10 fade-in">
            <div>
                <a href="consoles/student.html" class="inline-flex items-center gap-2 text-slate-400 hover:text-slate-600 font-bold text-sm mb-2 transition">
                    <i class="fas fa-arrow-left"></i> Back to Hub
                </a>
                <h1 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">Mistake Notebook</h1>
                <p class="text-slate-500 font-medium">Tracking growth for <span id="student-name" class="text-slate-800 font-bold">--</span>.</p>
            </div>
            <div class="hidden md:block">
                <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center text-red-500 text-2xl">
                    <i class="fas fa-book-open"></i>
                </div>
            </div>
        </header>

        <div id="mistakes-container" class="fade-in">
            <!-- Dynamic Content -->
        </div>
    </div>

</body>
</html>
