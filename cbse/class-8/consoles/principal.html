<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard ‚Äî Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Inter',sans-serif;}
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .ticker-item { display: inline-block; margin-right: 2rem; }
    </style>

    <script src="/masterpage_1/js/firebase-master-config.js"></script>

    <script type="module">
        import { checkRole, initializeAuthListener, requireAuth } from "../js/auth-paywall.js";
        import { DEMO_DATA } from "../js/demo-data.js";

        async function checkAccess() {
            const isAllowed = await checkRole("principal") || await checkRole("admin");
            if (!isAllowed) {
                // ... access denied UI ...
                return;
            }
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
            renderDashboard();
        }

        function renderDashboard() {
            // 1. Ticker
            const peaks = DEMO_DATA.gradeReport.filter(g => g.accuracy > 90).map(g => `üèÜ Class ${g.grade} - ${g.peak} (${g.accuracy}%)`).join("  ");
            const friction = DEMO_DATA.gradeReport.filter(g => g.accuracy < 65).map(g => `‚ö†Ô∏è Class ${g.grade} - ${g.friction} (${g.accuracy}%)`).join("  ");
            document.getElementById("ticker-content").innerHTML = `<span class="text-emerald-700 font-bold">${peaks}</span> <span class="mx-4 text-slate-300">|</span> <span class="text-red-600 font-bold">${friction}</span>`;

            // 2. Heatmap
            const grid = document.getElementById("heatmap-grid");
            grid.innerHTML = DEMO_DATA.gradeReport.map(g => {
                let color = g.accuracy >= 85 ? "emerald" : (g.accuracy >= 70 ? "amber" : "rose");

                return `
                <div onclick="loadDrillDown(${g.grade})" class="glass p-5 rounded-2xl cursor-pointer hover:scale-[1.02] transition shadow-sm border-l-4 border-${color}-500 group">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-black text-slate-800">Class ${g.grade}</h3>
                        <span class="text-xs font-bold bg-${color}-100 text-${color}-800 px-2 py-1 rounded-md">${g.accuracy}% Avg</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">Completion</span>
                            <span class="font-bold text-slate-700">${g.completion}%</span>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-${color}-500 h-full" style="width: ${g.completion}%"></div>
                        </div>
                        <div class="pt-2 mt-2 border-t border-slate-100 text-[10px] uppercase font-bold text-slate-400 group-hover:text-cbse-blue transition">
                            View Teacher Board &rarr;
                        </div>
                    </div>
                </div>`;
            }).join("");
        }

        window.loadDrillDown = (grade) => {
            const frame = document.getElementById("drill-down-frame");
            const title = document.getElementById("drill-down-title");

            frame.classList.remove("hidden");
            title.textContent = `Teacher Board ‚Äî Grade ${grade}`;
            title.classList.remove("hidden");

            // In a real app, we'd pass class ID to teacher.html
            // For demo, we just load the standard teacher console mock
            frame.src = `teacher.html?grade=${grade}`;

            frame.scrollIntoView({ behavior: 'smooth' });
        };

        window.doLogin = async () => {
            await requireAuth();
            location.reload();
        };

        initializeAuthListener(user => {
            if(user) {
                checkAccess();
            } else {
                document.getElementById("loading").innerHTML = `
                    <button onclick="doLogin()" class="bg-blue-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-black">
                        Sign In as Principal
                    </button>`;
            }
        });
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="animate-pulse font-bold text-slate-400">Loading Executive Suite...</div>
    </div>

    <div id="app" class="hidden max-w-7xl mx-auto p-4 md:p-8 fade-in">

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">Executive Dashboard</h1>
                <p class="text-slate-500 font-medium">Greenwood International School</p>
            </div>
            <div class="glass px-6 py-3 rounded-full text-xs font-bold uppercase tracking-widest text-slate-600 shadow-sm">
                Academic Year 2025-26
            </div>
        </header>

        <!-- Ticker -->
        <div class="glass rounded-xl p-4 mb-8 shadow-sm border-l-4 border-indigo-500">
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Live Intelligence Ticker</div>
            <div id="ticker-content" class="text-sm font-medium whitespace-nowrap overflow-x-auto scrollbar-hide">
                Loading insights...
            </div>
        </div>

        <!-- Heatmap -->
        <div class="mb-12">
            <h2 class="text-lg font-bold text-slate-900 mb-6 flex items-center gap-2">
                <span class="w-2 h-6 bg-blue-600 rounded-full"></span>
                Institutional Health Heatmap
            </h2>
            <div id="heatmap-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Cards -->
            </div>
        </div>

        <!-- Drill Down -->
        <h2 id="drill-down-title" class="text-lg font-bold text-slate-900 mb-4 hidden border-t border-slate-200 pt-8">Teacher Board</h2>
        <iframe id="drill-down-frame" class="w-full h-[800px] border-0 rounded-3xl hidden shadow-2xl"></iframe>

    </div>
</body>
</html>
