<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console â€” Ready4Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>body{font-family:'Inter',sans-serif;}</style>

    <script>
        window.__firebase_config = {
            apiKey:"AIzaSyAXdKiYRxBKAj280YcNuNwlKKDp85xpOWQ",
            authDomain:"quiz-signon.firebaseapp.com",
            projectId:"quiz-signon",
            storageBucket:"quiz-signon.appspot.com",
            messagingSenderId:"863414222321",
            appId:"1:863414222321:web:819f5564825308bcd9d850"
        };
    </script>

    <script type="module">
        import { checkRole, bulkOnboarding, revokeAccess, initializeAuthListener, requireAuth } from "../js/auth-paywall.js";

        async function checkAccess() {
            const isAdmin = await checkRole("admin");
            if (!isAdmin) {
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen">
                        <h1 class='text-3xl font-black text-red-600 mb-2'>ACCESS DENIED</h1>
                        <p class='text-slate-500'>You do not have administrative privileges.</p>
                        <button onclick="location.reload()" class="mt-4 text-blue-600 underline">Retry</button>
                    </div>`;
                return;
            }
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("app").classList.remove("hidden");
        }

        window.handleOnboarding = async () => {
            const csv = document.getElementById("csv-input").value;
            if (!csv) return alert("Please paste CSV data.");

            try {
                const btn = document.getElementById("btn-onboard");
                btn.disabled = true;
                btn.textContent = "Processing...";
                await bulkOnboarding(csv);
                alert("Bulk onboarding completed successfully.");
                document.getElementById("csv-input").value = "";
            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                const btn = document.getElementById("btn-onboard");
                btn.disabled = false;
                btn.textContent = "Run Bulk Onboarding";
            }
        };

        window.handleRevoke = async () => {
            const email = document.getElementById("revoke-email").value;
            if (!email) return alert("Enter email.");
            if (confirm(`Are you sure you want to revoke access for ${email}?`)) {
                try {
                    await revokeAccess(email);
                    alert("Access revoked.");
                    document.getElementById("revoke-email").value = "";
                } catch(e) {
                    alert("Error: " + e.message);
                }
            }
        };

        window.doLogin = async () => {
            await requireAuth();
            location.reload();
        };

        initializeAuthListener(user => {
            if(user) {
                checkAccess();
            } else {
                document.getElementById("loading").innerHTML = `
                    <button onclick="doLogin()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700">
                        Sign In as Admin
                    </button>`;
            }
        });
    </script>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="animate-pulse font-bold text-slate-400">Verifying Admin Access...</div>
    </div>

    <div id="app" class="hidden max-w-5xl mx-auto p-8 fade-in">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">Master IAM Console</h1>
                <p class="text-slate-500 font-medium">Identity & Access Management Board</p>
            </div>
            <div class="bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-xs font-bold uppercase">Admin Mode</div>
        </header>

        <!-- BULK ONBOARDING -->
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="bg-green-100 text-green-600 w-8 h-8 rounded-lg flex items-center justify-center text-sm">csv</span>
                Bulk Onboarding
            </h2>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">CSV Format Specification</p>
                <code class="text-sm text-slate-600 block">Email, Role, Section, Class</code>
                <p class="text-xs text-slate-400 mt-2">Example: <span class="font-mono text-slate-600">student1@school.com, student, 9A, 9</span></p>
            </div>

            <textarea id="csv-input" class="w-full h-40 p-4 border border-slate-200 rounded-xl text-sm font-mono mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Paste CSV data here..."></textarea>

            <div class="flex justify-end">
                <button id="btn-onboard" onclick="handleOnboarding()" class="bg-slate-900 text-white font-bold py-3 px-8 rounded-xl hover:bg-black transition shadow-lg shadow-slate-900/20">
                    Run Bulk Onboarding
                </button>
            </div>
        </div>

        <!-- REVOKE ACCESS -->
        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
            <h2 class="text-xl font-bold mb-4 text-red-600 flex items-center gap-2">
                <span class="bg-red-100 text-red-600 w-8 h-8 rounded-lg flex items-center justify-center text-sm">!</span>
                Global Access Revocation
            </h2>
            <p class="text-sm text-slate-500 mb-4">Immediately locks the user out of all paid content and suspends their role.</p>
            <div class="flex gap-4">
                <input type="email" id="revoke-email" placeholder="Enter user email address" class="flex-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:outline-none">
                <button onclick="handleRevoke()" class="bg-red-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-red-700 transition shadow-lg shadow-red-900/20">
                    Revoke Access
                </button>
            </div>
        </div>
    </div>
</body>
</html>
