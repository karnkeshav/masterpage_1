const fs = require('fs');
const path = require('path');

const getFiles = (dir, fileList = []) => {
  const files = fs.readdirSync(dir);
  files.forEach(file => {
    const name = path.join(dir, file);
    if (fs.statSync(name).isDirectory()) {
      if (!name.includes('node_modules') && !name.includes('.git')) getFiles(name, fileList);
    } else if (file === 'curriculum.js') fileList.push(name);
  });
  return fileList;
};

const curriculumFiles = getFiles('./');
const timestamp = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
const results = { cbse: [], scert: [], icse: [], other: [] };

curriculumFiles.forEach(filePath => {
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    const match = content.match(/curriculum\s*=\s*(\{[\s\S]*\});/);
    if (!match) return;

    const curriculum = eval(`(${match[1]})`);
    const pathParts = filePath.split(path.sep);
    const board = pathParts[0].toLowerCase();
    const className = pathParts[1].toUpperCase().replace('-', ' ');
    const targetBoard = results[board] ? board : 'other';

    Object.keys(curriculum).forEach(subject => {
      let totalChapters = 0;
      Object.keys(curriculum[subject]).forEach(book => {
        totalChapters += curriculum[subject][book].length;
      });
      // Store as a flat object for the table
      results[targetBoard].push({ 
        "Date": timestamp,
        "Class": className, 
        "Subject": subject, 
        "Chapters": totalChapters 
      });
    });
  } catch (e) { console.error(`Error: ${e.message}`); }
});

// Create Folders and Tables
Object.keys(results).forEach(board => {
  if (results[board].length === 0) return;

  const dir = path.join('data', board);
  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

  // 1. Generate Markdown Table
  let mdTable = `# ${board.toUpperCase()} Content Report - ${timestamp}\n\n`;
  mdTable += `| Class | Subject | Chapter Count |\n`;
  mdTable += `| :--- | :--- | :--- |\n`;
  results[board].forEach(row => {
    mdTable += `| ${row.Class} | ${row.Subject} | ${row.Chapters} |\n`;
  });

  // 2. Generate CSV for Excel
  let csv = `Date,Class,Subject,Chapters\n`;
  results[board].forEach(row => {
    csv += `${row.Date},${row.Class},${row.Subject},${row.Chapters}\n`;
  });

  fs.writeFileSync(path.join(dir, `table_${timestamp}.md`), mdTable);
  fs.writeFileSync(path.join(dir, `data_${timestamp}.csv`), csv);
});
